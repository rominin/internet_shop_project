# Инструкция

1. Соберите проект (**mvn clean package -DskipTests=true**),
   проверьте что архив в /target называется так же, как в Dockerfile.
2. Поднимите авторизационный сервер **docker compose up keycloak**. Проверьте, что в Keycloak созданы 
  - реалм internet-shop;
  - клиенты для Autorization Code Flow (main_module), Client Credentials Flow (main_module_m2m);
  - реалм роли ADMIN, USER;
  - юзеры Adminuser, testuser1, testuser2 с ролями (ADMIN, USER), USER, USER и паролями Adminpassword, testpassword1, 
testpassword2 соответственно. 
3. Поднимите остальные инфраструктурные модули: **docker-compose up db redis**.
4. Удостоверьтесь в логах контейнеров, что они подняты успешно, запустите контейнеры приложения **docker-compose up --build**.
5. Пользуйтесь приложением. Предлагается перейти в админскую панель http://localhost:8082/import и загрузить 
какие-нибудь товары (приложен работающий файл-пример "init_data.csv").
6. Также можно запустить тесты, например, из IDE; сначала запустите Keycloak.


# Главная страница - http://localhost:8082/products

# Технические характеристики

1. Приложение написано на Spring Boot.
2. Код приложения хранится в Git-репозитории GitHub.
3. Сборка приложения осуществляется с помощью системы сборки Maven.
4. Код приложения написан на Java 21.
5. Web UI приложения использует проект Spring WebFlux и подключается через соответствующий стартер.
6. Приложение использует Spring Data R2DBC для доступа к данным в БД.
7. База данных приложения - персистентная (PostgreSQL).
8. Приложение можно собрать из исходников и запустить локально.
9. Приложение упаковано в Executable JAR и запускается в Embedded Web Server (Netty).
10. Приложение покрыто тестами (юнит-, интеграционными) с использованием JUnit 5, TestContext Framework, Spring Boot Test и кеширования контекстов.
11. Executable JAR упакован в Docker-контейнер с открытым веб-портом для доступа из браузера (8082, 8081).
12. Приложение состоит из двух сервисов - основной сервис (витрина продуктов) и сервис платежей; общение по REST на реактивном стеке.
13. Написана OpenAPI спецификация интеграции основного приложения и сервиса платежей.
14. На основе разработанной OpenAPI спецификации сгенерированы:
    - клиент основного сервиса для осуществления запросов в сервис платежей;
    - REST-контроллер сервиса платежей для приёма запросов от основного приложения.
15. Основное приложение «Витрина интернет-магазина» и сервис платежей реализованы как подпроекты одного мультипроекта и собираются с помощью системы сборки Maven.
16. В основное приложение «Витрина интернет-магазина» добавлен реактивный стартер проекта Spring Data Redis.
17. В проект добавлена Spring Security в качестве модуля авторизации Spring Boot-приложений.
18. В приложении «Витрина интернет-магазина» есть авторизация пользователя (покупателя) по логину/паролю:
    - В качестве форм логина/логаута используются дефолтные, предоставленные Keycloak.
    - Данные пользователя сохраняются в БД (логин/пароль в зашифрованном виде и т. д.) Keycloak сервера — Spring Security использует эту информацию для аутентификации/авторизации пользователя.
    - Данные пользователя заранее сохранены в БД и не меняются.
    - При логауте пользователя полностью очищаются все связанные с ним куки, HttpSession и т. д., то есть пользователь полностью разлогинен.
19. С каждым авторизованным пользователем связаны его индивидуальная корзина с покупками и заказы:
    - При логине пользователь должен иметь доступ только к своей корзине.
    - Пользователь может совершать покупку только для своей корзины.
    - Пользователь может видеть только свои заказы.
20. В приложении «Витрина интернет-магазина»:
    - Все пользователи делятся на авторизованных и анонимных.
    - У анонимного пользователя есть доступ только к витрине товаров и к карточке самого товара, при этом он не может добавлять товары в корзину, переходить в корзину и заказы.
    - У авторизованного пользователя есть доступ ко всем страницам и элементам управления (кнопкам добавления заказа, осуществления платежа и т. д.).
    - Есть защита доступа анонимного пользователя к недоступным ресурсам как на HTML-уровне (кнопки, ссылки на недоступные ему ресурсы не показываются), так и на уровне эндпоинтов контроллеров приложения (показывается соответствующая ошибка).
21. В проект добавлен сервер авторизации OAuth2 - Keycloack.
    - В сервере авторизации зарегистрированы приложение «Витрина интернет-магазина» как клиент и RESTful-сервис платежей как сервер ресурсов (авторизация осуществляется по Client Credentials Flow).
    - Сервер авторизации запущен Docker-контейнере.
22. В HTTP-клиент для осуществления запросов в RESTful-сервис платежей приложения «Витрина интернет-магазина» добавлена возможность OAuth2-авторизации (используются данные клиента, зарегистрированного в сервисе авторизации).
23. В RESTful-сервис платежей добавлена возможность авторизации приложения «Витрина интернет-магазина» как клиента для доступа к эндпоинтам проверки баланса и осуществления платежа (используются данные сервера ресурсов, зарегистрированного в сервисе авторизации).
24. Если приложение «Витрина интернет-магазина» как клиент не авторизовано в сервисе авторизации, то оно не имеет возможность выполнять запросы к RESTful-сервису платежей как к серверу ресурсов (получает соответствующую ошибку). 

# Функциональность

1. Веб-приложение представляет собой витрину товаров, которые пользователь может положить в корзину и купить.

2. Пользователи делятся на два типа: авторизованные и анонимные.

3. Должна быть возможность авторизоваться в приложении по логину/паролю и разлогиниться.

4. Приложение состоит из шести основных частей (модулей):
    - страницы витрины товаров, доступных для просмотра и покупки;
    - страницы товара;
    - страницы корзины покупателя;
    - страницы всех заказов;
    - страницы заказа;
    - сервиса покупки, который осуществляет REST-запросы в сервис платежей.

5. Страница витрины товаров — это веб-страница (HTML + JavaScript), на которой представлены:
    - список товаров, доступных для заказа (картинка, название, цена, кнопка добавления в корзину/удаления из неё, кнопка изменения количества товара в корзине);
    - список товаров может быть представлен в любом виде (списком, плиткой);
    - есть пагинация (по 10, 20, 50, 100 товаров);
    - сверху строка поиска с фильтрацией по вхождению слова в название товара;
    - сверху доступна сортировка по цене, алфавиту;
    - список товаров берётся из кеша товаров в Redis, а если в кеше данных нет, то загружается в него из БД;
    - кнопки добавления товара в корзину, удаления из неё, изменения количества товара в корзине доступны только авторизованным пользователям.

6. При нажатии на товар происходит переход на веб-страницу карточки товара, на которой представлены:
    - название, картинка, описание товара, возможность положить товар в корзину/удалить его, изменить количество в корзине;
    - цена товара;
    - данные о товаре берутся из кеша товаров в Redis, а если в кеше данных нет, то загружаются в него из БД;
    - возможность положить товар в корзину/удалить его, изменить его количество в корзине есть только у авторизованного пользователя.

7. В правом верхнем углу любой веб-страницы есть кнопка перехода в корзину (доступна только авторизованным пользователям), которая представляет собой веб-страницу:
    - веб-страницу со списком положенных в неё товаров, их количеством, ценой каждого товара и общей ценой всей корзины;
    - есть возможность удалить товар из корзины, изменить его количество;
    - с кнопкой оформления заказа (доступна, если на балансе в сервисе платежей достаточно средств; если недостаточно или сервис недоступен, то пишется соответствующее сообщение);
    - данные в списке товаров берутся из кеша товаров в Redis, а если в кеше данных нет, то загружаются в него из БД;
    -  корзина привязана к пользователю, то есть у каждого пользователя своя корзина товаров.

8. В правом верхнем углу любой веб-страницы есть кнопка перехода в заказы (доступна только авторизованным пользователям), которая представляет собой:
    - веб-страницу со списком всех оформленных заказов, суммой каждого заказа и общей суммой всех заказов;
    - при нажатии на заказ появляется веб-страница совершённого заказа;
    - список заказов привязан к пользователю, то есть у каждого пользователя свой список заказов.

9. На веб-странице заказа представлен список купленных товаров (картинка, название, цена). Страница заказа доступна только авторизованным пользователям.

10. При нажатии на кнопку оформления заказа (доступна только авторизованным пользователям) осуществляется REST-запрос в сервис платежей, и при успешной оплате покупки происходят эмуляция оформления заказа и переход на страницу оформленного заказа.

11. RESTful-сервис платежей обрабатывает запросы только от авторизованного по OAuth2 основного приложения «Витрина интернет-магазина».

12. Время жизни данных о товарах в кеше берётся: 3 мин.

13. Данные о товарах, которые кешируются в Redis:
    - для карточки товара: идентификатор, картинка, название, цена, описание;
    - для списка товаров: идентификатор, название, описание, цена (они нужны для поиска, сортировки и пейджинга).

14. Есть возможность загрузки списка товаров на витрину товаров (импорт из файла).

15. Пользователи приложения изначально загружены в БД.

16. Сервис платежей представляет собой RESTful-приложение с двумя реактивными HTTP-эндпоинтами:
    - получением баланса на счёте (на ваш выбор логика получения баланса: случайный баланс, загрузка из БД, фиксированный баланс, загрузка из конфига) — если баланс меньше суммы стоимости товаров в корзине, то кнопка оформления заказа основного приложения недоступна (счёт привязан к авторизованному пользователю);
    - осуществлением платежа (при нажатии на кнопку оформления заказа происходит запрос на вычитание суммы заказа из баланса) — если оно даёт отрицательный результат, то считается, что оплата заказа не прошла, и он не оформляется, выдаётся соответствующая ошибка (счёт привязан к авторизованному пользователю).
    
17. Если сервис платежей недоступен, то должна быть недоступна кнопка оформления заказа. В таком случае показывается соответствующее сообщение.

18. Обмен сообщениями с сервисом платежей происходит в формате JSON.

19. В качестве сервера авторизации OAuth2 выбран Keycloak.

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>–í—Å–µ —Ç–æ–≤–∞—Ä—ã</title>
</head>
<body>
<h1>–í—Å–µ —Ç–æ–≤–∞—Ä—ã</h1>

<form method="get" action="#" th:action="@{/products}">
    <label for="search">–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é:</label>
    <input type="text" id="search" name="keyword" th:value="${param.keyword}">

    <label for="minPrice">–¶–µ–Ω–∞ –æ—Ç:</label>
    <input type="number" id="minPrice" name="minPrice" th:value="${param.minPrice}" step="0.01">

    <label for="maxPrice">–¥–æ:</label>
    <input type="number" id="maxPrice" name="maxPrice" th:value="${param.maxPrice}" step="0.01">

    <label for="sortBy">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ:</label>
    <select id="sortBy" name="sortBy">
        <option value="name" th:selected="${param.sortBy != null and param.sortBy[0] == 'name'}">–ê–ª—Ñ–∞–≤–∏—Ç—É</option>
        <option value="price" th:selected="${param.sortBy != null and param.sortBy[0] == 'price'}">–¶–µ–Ω–µ</option>
    </select>

    <label for="sortOrder">–ü–æ—Ä—è–¥–æ–∫:</label>
    <select id="sortOrder" name="sortOrder">
        <option value="asc" th:selected="${param.sortOrder != null and param.sortOrder[0] == 'asc'}">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
        <option value="desc" th:selected="${param.sortOrder != null and param.sortOrder[0] == 'desc'}">–ü–æ —É–±—ã–≤–∞–Ω–∏—é</option>
    </select>

    <input type="hidden" name="size" th:value="${param.size}">

    <button type="submit">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
</form>

<hr>

<table border="1">
    <thead>
    <tr>
        <th>–ö–∞—Ä—Ç–∏–Ω–∫–∞</th>
        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
        <th>–¶–µ–Ω–∞</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="product : ${products}">
        <td>
            <img th:src="@{${product.imageUrl}}" alt="Product Image" width="50">
        </td>
        <td th:text="${product.name}"></td>
        <td th:text="${product.price}"></td>
        <td>
            <a th:href="@{/products/{id}(id=${product.id})}">–ü—Ä–æ—Å–º–æ—Ç—Ä</a>

            <form method="post" th:action="@{/cart/add}" style="display:inline;">
                <input type="hidden" name="productId" th:value="${product.id}">
                <input type="hidden" name="quantity" value="1">
                <button type="submit">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
            </form>

            <form method="post" th:action="@{/cart/remove}" style="display:inline;">
                <input type="hidden" name="productId" th:value="${product.id}">
                <button type="submit">–£–¥–∞–ª–∏—Ç—å –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã</button>
            </form>

            <form method="post" th:action="@{/cart/update}" style="display:inline;">
                <input type="hidden" name="productId" th:value="${product.id}">
                <input type="number" name="quantity" min="1" value="1">
                <button type="submit">–û–±–Ω–æ–≤–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</button>
            </form>
        </td>
    </tr>
    </tbody>
</table>

<div>
    <span>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ:</span>
    <a th:href="@{/products(size=10, sortBy=${param.sortBy}, sortOrder=${param.sortOrder}, minPrice=${param.minPrice}, maxPrice=${param.maxPrice}, keyword=${param.keyword})}">10</a> |
    <a th:href="@{/products(size=20, sortBy=${param.sortBy}, sortOrder=${param.sortOrder}, minPrice=${param.minPrice}, maxPrice=${param.maxPrice}, keyword=${param.keyword})}">20</a> |
    <a th:href="@{/products(size=50, sortBy=${param.sortBy}, sortOrder=${param.sortOrder}, minPrice=${param.minPrice}, maxPrice=${param.maxPrice}, keyword=${param.keyword})}">50</a> |
    <a th:href="@{/products(size=100, sortBy=${param.sortBy}, sortOrder=${param.sortOrder}, minPrice=${param.minPrice}, maxPrice=${param.maxPrice}, keyword=${param.keyword})}">100</a>
</div>

<div>
    <span>–°—Ç—Ä–∞–Ω–∏—Ü–∞:</span>
    <a th:if="${currentPage > 0}"
       th:href="@{/products(size=${pageSize}, page=${currentPage - 1}, sortBy=${param.sortBy}, sortOrder=${param.sortOrder}, minPrice=${param.minPrice}, maxPrice=${param.maxPrice}, keyword=${param.keyword})}">
        –ù–∞–∑–∞–¥
    </a>

    <span th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
        <a th:href="@{/products(size=${pageSize}, page=${i}, sortBy=${param.sortBy}, sortOrder=${param.sortOrder}, minPrice=${param.minPrice}, maxPrice=${param.maxPrice}, keyword=${param.keyword})}"
           th:text="${i + 1}"
           th:classappend="${i == currentPage} ? 'active' : ''"></a>
        |
    </span>

    <a th:if="${currentPage < totalPages - 1}"
       th:href="@{/products(size=${pageSize}, page=${currentPage + 1}, sortBy=${param.sortBy}, sortOrder=${param.sortOrder}, minPrice=${param.minPrice}, maxPrice=${param.maxPrice}, keyword=${param.keyword})}">
        –í–ø–µ—Ä–µ–¥
    </a>
</div>

<!-- TODO –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ –ø—Ä–∞–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π —É–≥–æ–ª-->
<p><a href="/cart">–ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É üõí</a></p>

<div id="notification" style="
    display: none;
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: #4CAF50;
    color: white;
    padding: 15px;
    border-radius: 5px;
    box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
    z-index: 1000;
">
    <span id="notification-message"></span>
</div>

<script>
    function showNotification(message) {
        let notification = document.getElementById("notification");
        let messageSpan = document.getElementById("notification-message");
        messageSpan.textContent = message;
        notification.style.display = "block";

        setTimeout(function () {
            notification.style.display = "none";
        }, 2000);
    }

    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll("form").forEach(form => {
            let method = form.getAttribute("method").toUpperCase();

            if (method === "GET") {
                return;
            }

            form.addEventListener("submit", function (event) {
                event.preventDefault();

                let formData = new FormData(form);
                let actionUrl = form.getAttribute("action");

                fetch(actionUrl, {
                    method: "POST",
                    body: formData
                }).then(response => {
                    if (response.ok) {
                        let message = "–î–µ–π—Å—Ç–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ!";
                        if (actionUrl.includes("/cart/add")) {
                            message = "–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É!";
                        } else if (actionUrl.includes("/cart/remove")) {
                            message = "–¢–æ–≤–∞—Ä —É–¥–∞–ª—ë–Ω –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã!";
                        } else if (actionUrl.includes("/cart/update")) {
                            message = "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!";
                        }
                        showNotification(message);
                    } else {
                        showNotification("–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è!");
                    }
                }).catch(() => {
                    showNotification("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏!");
                });
            });
        });
    });
</script>

</body>
</html>